FROM alpine:3.22

# Base build deps
RUN apk add --no-cache \
    bash curl git jq ca-certificates \
    build-base musl-dev pkgconf \
    openssl-dev openssl-libs-static zlib-dev zlib-static \
    bats

# Install Rust
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH
ARG RUST_VERSION=1.90.0
RUN curl -sSf https://sh.rustup.rs \
    | sh -s -- -y --default-toolchain ${RUST_VERSION} --profile minimal \
    && rustup component add rustfmt clippy rust-analyzer \
    && rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-musl

# Default env for static linking
ENV CARGO_PROFILE_RELEASE_LTO=fat \
    CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1 \
    CARGO_PROFILE_RELEASE_STRIP=true \
    PKG_CONFIG_ALL_STATIC=1 \
    OPENSSL_STATIC=1

